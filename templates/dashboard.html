<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AutoAffiliate Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
body { padding: 20px; }
#posts_table td, #posts_table th { font-size: 0.9rem; }
</style>
</head>
<body>
<div class="container">
    <h1>AutoAffiliate Dashboard</h1>
    <div class="mb-3">
        <button class="btn btn-success" onclick="startWorker()">Start Worker</button>
        <button class="btn btn-danger" onclick="stopWorker()">Stop Worker</button>
        <button class="btn btn-primary" onclick="refreshSources()">Refresh Sources</button>
        <button class="btn btn-warning" onclick="postNext()">Post Next Pending</button>
    </div>

    <h3>Worker Status</h3>
    <div id="status">Loading...</div>

    <h3>Recent Posts</h3>
    <table class="table table-striped" id="posts_table">
        <thead>
            <tr>
                <th>ID</th><th>URL</th><th>Status</th><th>Created At</th><th>Posted At</th><th>Meta</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
async function updateStatus(){
    const res = await axios.get("/api/status");
    document.getElementById("status").innerText = `Worker Running: ${res.data.worker_running}, Stop Requested: ${res.data.stop_requested}`;
}
async function loadPosts(){
    const res = await axios.get("/api/posts");
    const tbody = document.querySelector("#posts_table tbody");
    tbody.innerHTML = "";
    res.data.forEach(p=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${p.id}</td><td>${p.url}</td><td>${p.status}</td><td>${p.created_at}</td><td>${p.posted_at||''}</td><td>${JSON.stringify(p.meta)}</td>`;
        tbody.appendChild(tr);
    });
}
async function startWorker(){ await axios.post("/api/start_worker"); updateStatus(); }
async function stopWorker(){ await axios.post("/api/stop_worker"); updateStatus(); }
async function refreshSources(){ const r=await axios.post("/api/refresh_sources"); alert(`Links saved: ${r.data.links_saved}`); loadPosts(); }
async function postNext(){ const r=await axios.post("/api/post_next"); alert(`Post success: ${r.data.success}`); loadPosts(); }
setInterval(updateStatus,5000); setInterval(loadPosts,7000); updateStatus(); loadPosts();
</script>
</body>
</html>
