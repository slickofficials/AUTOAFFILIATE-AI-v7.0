<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AutoAffiliate Dashboard</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
  .toast {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 1000;
    padding: 1rem 1.5rem;
    background: #4a4a4a;
    color: white;
    border-radius: 6px;
    opacity: 0.95;
    display: none;
  }
  .status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-left: 8px;
  }
</style>
</head>
<body>
<section class="section">
  <div class="container">
    <h1 class="title has-text-centered">AutoAffiliate Dashboard</h1>

    <div class="columns is-vcentered is-multiline">
      <div class="column is-one-quarter">
        <div class="box has-text-centered">
          <p class="heading">Worker Status 
            <span id="worker-indicator" class="status-indicator"></span>
          </p>
          <button id="start-worker" class="button is-success is-fullwidth mb-2">Start Worker</button>
          <button id="stop-worker" class="button is-danger is-fullwidth">Stop Worker</button>
        </div>
      </div>
      <div class="column is-three-quarters">
        <div class="box">
          <h2 class="subtitle">Stats</h2>
          <div class="columns is-multiline">
            <div class="column is-one-quarter"><p>Total Posts: <strong id="stat-total">0</strong></p></div>
            <div class="column is-one-quarter"><p>Pending: <strong id="stat-pending">0</strong></p></div>
            <div class="column is-one-quarter"><p>Sent: <strong id="stat-sent">0</strong></p></div>
            <div class="column is-one-quarter"><p>Failed: <strong id="stat-failed">0</strong></p></div>
            <div class="column is-half"><p>Last Posted At: <strong id="stat-last-posted">N/A</strong></p></div>
            <div class="column is-half"><p>Total Clicks: <strong id="stat-clicks">0</strong></p></div>
          </div>
        </div>
      </div>
    </div>

    <div class="columns">
      <div class="column">
        <div class="box has-text-centered">
          <button id="refresh-sources" class="button is-info is-fullwidth">Refresh Affiliate Sources</button>
        </div>
      </div>
      <div class="column">
        <div class="box has-text-centered">
          <button id="manual-link-btn" class="button is-primary is-fullwidth">Add Manual Link</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Manual link modal -->
<div id="manual-link-modal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Add Manual Link</p>
      <button class="delete" aria-label="close"></button>
    </header>
    <section class="modal-card-body">
      <div class="field">
        <label class="label">HTTPS Link</label>
        <div class="control">
          <input class="input" type="url" id="manual-link-input" placeholder="https://example.com/affiliate-link">
        </div>
      </div>
    </section>
    <footer class="modal-card-foot">
      <button id="manual-link-submit" class="button is-success">Submit</button>
      <button class="button cancel-btn">Cancel</button>
    </footer>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const toast = document.getElementById('toast');

function showToast(message, duration=3000){
  toast.textContent = message;
  toast.style.display = 'block';
  setTimeout(()=>{ toast.style.display='none'; }, duration);
}

async function fetchStats() {
  try {
    const res = await axios.get('/api/stats');
    const s = res.data;
    document.getElementById('stat-total').textContent = s.total;
    document.getElementById('stat-pending').textContent = s.pending;
    document.getElementById('stat-sent').textContent = s.sent;
    document.getElementById('stat-failed').textContent = s.failed;
    document.getElementById('stat-last-posted').textContent = s.last_posted_at || 'N/A';
    document.getElementById('stat-clicks').textContent = s.clicks_total;

    // worker indicator
    const indicator = document.getElementById('worker-indicator');
    if(s.worker_running) {
      indicator.style.backgroundColor = 'green';
    } else {
      indicator.style.backgroundColor = 'red';
    }
  } catch(e){
    console.error(e);
    showToast('Failed to fetch stats');
  }
}

async function toggleWorker(start=true){
  try {
    const url = start ? '/api/worker/start' : '/api/worker/stop';
    await axios.post(url);
    showToast(start ? 'Worker started' : 'Worker stopped');
    fetchStats();
  } catch(e){
    console.error(e);
    showToast('Worker action failed');
  }
}

document.getElementById('start-worker').addEventListener('click', ()=>toggleWorker(true));
document.getElementById('stop-worker').addEventListener('click', ()=>toggleWorker(false));
document.getElementById('refresh-sources').addEventListener('click', async ()=>{
  try{
    const res = await axios.post('/api/refresh');
    showToast(`Refreshed ${res.data.saved} links`);
    fetchStats();
  } catch(e){
    console.error(e);
    showToast('Refresh failed');
  }
});

// manual link modal logic
const modal = document.getElementById('manual-link-modal');
document.getElementById('manual-link-btn').addEventListener('click', ()=>modal.classList.add('is-active'));
modal.querySelector('.delete').addEventListener('click', ()=>modal.classList.remove('is-active'));
modal.querySelector('.cancel-btn').addEventListener('click', ()=>modal.classList.remove('is-active'));

document.getElementById('manual-link-submit').addEventListener('click', async ()=>{
  const url = document.getElementById('manual-link-input').value;
  if(!url.startsWith('https://')){
    return showToast('Link must start with HTTPS');
  }
  try{
    const res = await axios.post('/api/manual-link', {url});
    showToast(`Added: ${res.data.inserted} link(s)`);
    modal.classList.remove('is-active');
    document.getElementById('manual-link-input').value = '';
    fetchStats();
  } catch(e){
    console.error(e);
    showToast('Failed to add link');
  }
});

// auto-refresh stats every 15s
setInterval(fetchStats, 15000);
fetchStats();
</script>
</body>
</html>
