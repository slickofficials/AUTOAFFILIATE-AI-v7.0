<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>{{ title or "HQ Dashboard" }}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* iOS metallic + readable text */
    :root {
      --accent: #5eead4;
      --accent-2: #34d399;
      --card: linear-gradient(180deg,#0f1724 0%, #0b1220 100%);
      --muted: #cbd5e1;
    }
    body {
      background: radial-gradient(circle at 10% 10%, #071023 0%, #07101a 45%, #02040a 100%);
      color: var(--muted);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing: antialiased;
      padding-bottom: 40px;
    }
    .navbar { background: transparent; border-bottom: 1px solid rgba(255,255,255,0.03); }
    .brand {
      font-weight: 600; color: white;
      text-shadow: 0 2px 10px rgba(0,0,0,0.6);
    }
    .card {
      background: var(--card);
      border: 1px solid rgba(100,210,188,0.08);
      box-shadow: 0 6px 30px rgba(2,6,23,0.6);
      color: var(--muted);
      border-radius: 14px;
    }
    .kpi { font-size: 1.25rem; color: #e6eef6; font-weight:600; }
    .kpi-small { color: rgba(230,238,246,0.75); font-size: 0.95rem; }
    .btn-primary {
      background: linear-gradient(90deg,var(--accent),var(--accent-2));
      border: none;
      box-shadow: 0 6px 18px rgba(16,185,129,0.08);
      color: #042027;
    }
    .btn-primary:hover { opacity: 0.95; }
    .chart-container { height: 320px; }
    small.muted { color: rgba(230,238,246,0.6); }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg mb-4">
    <div class="container-fluid">
      <a class="navbar-brand brand" href="#">âš¡ {{ company or "SlickOfficials HQ" }}</a>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-light" id="refreshBtn">ðŸ”„ Refresh</button>
        <a class="btn btn-sm btn-primary" href="/logout">Logout</a>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <div class="card p-3">
          <div class="kpi" id="clicks">0</div>
          <div class="kpi-small">Total Clicks</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3">
          <div class="kpi" id="conversions">0</div>
          <div class="kpi-small">Conversions</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3">
          <div class="kpi" id="revenue">$0.00</div>
          <div class="kpi-small">Estimated Revenue</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3">
          <div class="kpi" id="lastPost">Never</div>
          <div class="kpi-small">Last Post</div>
        </div>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-12">
        <div class="card p-3">
          <div class="d-flex justify-content-between mb-2">
            <div><strong>Activity</strong> <small class="muted">Posts / Clicks timeline</small></div>
            <div>
              <button class="btn btn-sm btn-success" id="startBot">Start Bot</button>
              <button class="btn btn-sm btn-danger" id="stopBot">Stop Bot</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="activityChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-md-6">
        <div class="card p-3">
          <h6>Top Links</h6>
          <ul id="topLinks" class="list-unstyled mb-0"></ul>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-3">
          <h6>Settings</h6>
          <label class="form-label">Posting interval (seconds)</label>
          <input type="number" id="intervalInput" class="form-control mb-2" placeholder="3600">
          <button class="btn btn-primary" id="updateInterval">Update</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    const clicksEl = document.getElementById('clicks');
    const convEl = document.getElementById('conversions');
    const revEl = document.getElementById('revenue');
    const lastEl = document.getElementById('lastPost');
    const topLinksEl = document.getElementById('topLinks');
    const intervalInput = document.getElementById('intervalInput');

    let chart;
    function drawChart(labels=[], values=[]){
      const ctx = document.getElementById('activityChart').getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Posts per interval',
            data: values,
            fill: true,
            tension: 0.35,
            borderWidth: 2
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { x: { grid: { display:false } }, y: { grid: { color: 'rgba(255,255,255,0.03)' } } }
        }
      });
    }

    async function loadStats(){
      try {
        const res = await axios.get('/api/stats');
        const data = res.data;
        clicksEl.textContent = data.clicks_total || 0;
        convEl.textContent = data.conversions || 0;
        revEl.textContent = '$' + (data.revenue || 0).toFixed(2);
        lastEl.textContent = data.last_post_time ? new Date(data.last_post_time).toLocaleString() : 'Never';
        // top links
        topLinksEl.innerHTML = '';
        (data.top_links || []).forEach(t => {
          const li = document.createElement('li');
          li.innerHTML = `<small style="color:#9fb9b3">${t.clicks} clicks</small> <a href="${t.url}" target="_blank" style="color:var(--accent)">${t.url}</a>`;
          topLinksEl.appendChild(li);
        });
        // chart data (fallback if none)
        drawChart(data.chart_labels || [], data.chart_values || []);
      } catch (e){
        console.error('loadStats error', e);
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', loadStats);
    document.getElementById('startBot').addEventListener('click', async ()=>{
      await axios.post('/api/control', { action: 'start' }); loadStats();
    });
    document.getElementById('stopBot').addEventListener('click', async ()=>{
      await axios.post('/api/control', { action: 'stop' }); loadStats();
    });
    document.getElementById('updateInterval').addEventListener('click', async ()=>{
      const val = parseInt(intervalInput.value || 3600);
      await axios.post('/api/interval', { interval: val });
      alert('Interval updated to ' + val + ' seconds');
    });

    // initial load
    loadStats();
    // refresh every 60s on dashboard
    setInterval(loadStats, 60000);
  </script>
</body>
</html>
