<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ title or "HQ Dashboard (iOS Style)" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg-light: #f5f5f7;
      --bg-dark: #1c1c1e;
      --card-light: #ffffffcc;
      --card-dark: #2c2c2e;
      --text-light: #000;
      --text-dark: #fff;
      --accent: linear-gradient(145deg, #d1d1d6, #f2f2f7);
      --accent-dark: linear-gradient(145deg, #3a3a3c, #1c1c1e);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
      margin: 0;
      background: var(--bg-light);
      color: var(--text-light);
      transition: background 0.3s, color 0.3s;
    }
    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    header {
      padding: 20px;
      background: var(--accent);
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(10px);
      transition: background 0.3s;
    }
    body.dark header {
      background: var(--accent-dark);
    }
    .brand { font-weight: 700; font-size: 18px; }
    main { padding: 20px; max-width: 1100px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
    .card {
      background: var(--card-light);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      transition: background 0.3s;
    }
    body.dark .card { background: var(--card-dark); }
    h2 { margin: 0 0 12px; font-size: 18px; }
    button {
      background: #007aff;
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    button.secondary { background: #8e8e93; }
    button:hover { background: #005ecb; }
    input, select {
      background: #f2f2f7;
      border: none;
      border-radius: 12px;
      padding: 10px;
      width: 100%;
      margin-top: 8px;
    }
    body.dark input, body.dark select { background: #3a3a3c; color: #fff; }
    .stats { display: flex; flex-wrap: wrap; gap: 12px; }
    .stat {
      flex: 1;
      min-width: 120px;
      background: #e5e5ea;
      border-radius: 16px;
      padding: 12px;
      text-align: center;
      font-weight: 600;
    }
    body.dark .stat { background: #2c2c2e; }
    .health span {
      display: inline-block;
      margin: 4px 8px 0 0;
      padding: 6px 10px;
      border-radius: 10px;
      background: #e5e5ea;
      font-size: 13px;
    }
    body.dark .health span { background: #2c2c2e; }
    .ok { color: #34c759; }
    .bad { color: #ff3b30; }
    .toggle {
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 12px;
      background: #e5e5ea;
      font-size: 14px;
    }
    body.dark .toggle { background: #2c2c2e; color: #fff; }
  </style>
</head>
<body>
<header>
  <div class="brand">{{ company }}</div>
  <div>
    <span class="toggle" onclick="toggleMode()">üåô/‚òÄÔ∏è</span>
    <a href="/logout"><button class="secondary">Logout</button></a>
  </div>
</header>

<main>
  <div class="grid">
    <div class="card">
      <h2>Controls</h2>
      <button onclick="startWorker()">‚ñ∂ Start</button>
      <button class="secondary" onclick="stopWorker()">‚èπ Stop</button>
      <button class="secondary" onclick="refresh()">üîÑ Refresh</button>
      <input id="enqueueUrl" placeholder="Paste URL">
      <select id="enqueueSource">
        <option value="manual">manual</option>
        <option value="rakuten">rakuten</option>
        <option value="awin">awin</option>
      </select>
      <button onclick="enqueue()">‚ûï Enqueue</button>
      <input id="intervalMin" type="number" min="1" value="180">
      <button onclick="updateInterval()">‚è± Set interval</button>
    </div>

    <div class="card">
      <h2>Overview</h2>
      <div class="stats">
        <div class="stat">Total<br><span id="total_links">-</span></div>
        <div class="stat">Pending<br><span id="pending">-</span></div>
        <div class="stat">Sent<br><span id="sent">-</span></div>
        <div class="stat">Clicks<br><span id="clicks_total">-</span></div>
      </div>
      <p>Last posted: <span id="last_posted_at">-</span></p>
      <p>Next post in: <span id="next_post_in_seconds">-</span> sec</p>
    </div>

    <div class="card">
      <h2>Bot health</h2>
      <div class="health" id="health"></div>
    </div>
  </div>

  <div class="grid" style="margin-top:16px;">
    <div class="card">
      <h2>Top links</h2>
      <ul id="top_links"></ul>
    </div>
    <div class="card">
      <h2>Recent posts</h2>
      <ul id="recent_posts"></ul>
    </div>
  </div>
</main>

<script>
function toggleMode() {
  document.body.classList.toggle('dark');
}
async function fetchStats() {
  const res = await fetch('/api/stats');
  const data = await res.json();
  setText('total_links', data.total_links);
  setText('pending', data.pending);
  setText('sent', data.sent);
  setText('clicks_total', data.clicks_total);
  setText('last_posted_at', data.last_posted_at || '-');
  setText('next_post_in_seconds', data.next_post_in_seconds ?? '-');
  const healthEl = document.getElementById('health');
  healthEl.innerHTML = '';
  Object.entries(data.statuses || {}).forEach(([k,v]) => {
    const span = document.createElement('span');
    span.className = v ? 'ok' : 'bad';
    span.textContent = `${k}: ${v ? 'ok' : 'off'}`;
    healthEl.appendChild(span);
  });
  const topEl = document.getElementById('top_links');
  topEl.innerHTML = '';
  (data.top_links || []).forEach(i => {
    const li = document.createElement('li');
    li.innerHTML = `<a href="/r/${i.id}" target="_blank">${i.url}</a> ‚Äî clicks: ${i.clicks}`;
    topEl.appendChild(li);
  });
  const recentEl = document.getElementById('recent_posts');
  recentEl.innerHTML = '';
  (data.recent_posts || []).forEach(i => {
    const li = document.createElement('li');
    li.textContent = `${i.status} ‚Äî ${i.url} (${i.posted_at || 'n/a'})`;
    recentEl.appendChild(li);
  });
}
function setText(id, val) { const el = document.getElementById(id); if (el) el.textContent = val; }
async function startWorker(){await fetch('/start',{method:'POST'});alert('Start requested');}
async function stopWorker(){await fetch('/stop
